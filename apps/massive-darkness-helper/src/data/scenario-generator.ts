/**
 * Seed-based –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –¥–ª—è –ö—Ä–æ–º–µ—à–Ω–∞—è –¢—å–º–∞: –ü—Ä–µ–∏—Å–ø–æ–¥–Ω—è—è
 *
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç mulberry32 PRNG –¥–ª—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.
 * –û–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Å–∏–¥ –≤—Å–µ–≥–¥–∞ –¥–∞—ë—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π.
 */

import type {
  DifficultyLevel,
  DoorType,
  GeneratedScenario,
  GridPosition,
  LayoutType,
  MapLayout,
  MapSize,
  MapTile,
  Objective,
  ObjectiveType,
  PlacedTile,
  ScenarioConfig,
  SpecialRule,
  TileRole,
  TokenPlacement,
  WinLoseConditions,
} from './scenario-types';

// ============================================================
// PRNG (mulberry32)
// ============================================================

function hashSeed(seed: string): number {
  let h = 0;
  for (let i = 0; i < seed.length; i++) {
    h = (Math.imul(31, h) + seed.charCodeAt(i)) | 0;
  }
  return h >>> 0;
}

function mulberry32(seed: number): () => number {
  let s = seed | 0;
  return () => {
    s = (s + 0x6d2b79f5) | 0;
    let t = Math.imul(s ^ (s >>> 15), 1 | s);
    t = (t + Math.imul(t ^ (t >>> 7), 61 | t)) ^ t;
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}

class SeededRandom {
  private next: () => number;

  constructor(seed: string) {
    this.next = mulberry32(hashSeed(seed));
    // –ü—Ä–æ–≥—Ä–µ–≤ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–Ω–∞—á–µ–Ω–∏–π
    for (let i = 0; i < 5; i++) this.next();
  }

  /** –°–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ [0, 1) */
  random(): number {
    return this.next();
  }

  /** –¶–µ–ª–æ–µ —á–∏—Å–ª–æ [min, max] –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ */
  int(min: number, max: number): number {
    return Math.floor(this.random() * (max - min + 1)) + min;
  }

  /** –°–ª—É—á–∞–π–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –º–∞—Å—Å–∏–≤–∞ */
  pick<T>(arr: readonly T[]): T {
    return arr[Math.floor(this.random() * arr.length)];
  }

  /** –ù–µ—Å–∫–æ–ª—å–∫–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –º–∞—Å—Å–∏–≤–∞ */
  pickN<T>(arr: readonly T[], n: number): T[] {
    const copy = [...arr];
    const result: T[] = [];
    const count = Math.min(n, copy.length);
    for (let i = 0; i < count; i++) {
      const idx = Math.floor(this.random() * copy.length);
      result.push(copy[idx]);
      copy.splice(idx, 1);
    }
    return result;
  }

  /** –ü–µ—Ä–µ–º–µ—à–∞—Ç—å –º–∞—Å—Å–∏–≤ */
  shuffle<T>(arr: T[]): T[] {
    const copy = [...arr];
    for (let i = copy.length - 1; i > 0; i--) {
      const j = Math.floor(this.random() * (i + 1));
      [copy[i], copy[j]] = [copy[j], copy[i]];
    }
    return copy;
  }
}

// ============================================================
// –ü—É–ª—ã –¥–∞–Ω–Ω—ã—Ö
// ============================================================

const NAME_PREFIXES = [
  '–ü—Ä–æ–∫–ª—è—Ç—ã–π',
  '–ó–∞—Ç–µ—Ä—è–Ω–Ω—ã–π',
  '–ü—ã–ª–∞—é—â–∏–π',
  '–ú—Ä–∞—á–Ω—ã–π',
  '–ó–∞–±—ã—Ç—ã–π',
  '–ö—Ä–æ–≤–∞–≤—ã–π',
  '–î—Ä–µ–≤–Ω–∏–π',
  '–ü–æ—Ä–æ—á–Ω—ã–π',
  '–°—É–º—Ä–∞—á–Ω—ã–π',
  '–õ–µ–¥—è–Ω–æ–π',
  '–î—å—è–≤–æ–ª—å—Å–∫–∏–π',
  '–ü–æ–≥–∏–±–µ–ª—å–Ω—ã–π',
  '–¢–µ–Ω–µ–≤–æ–π',
  '–ò–Ω—Ñ–µ—Ä–Ω–∞–ª—å–Ω—ã–π',
  '–ü—Ä–æ–∫–ª—è—Ç–∏–π',
  '–ó–ª–æ–≤–µ—â–∏–π',
  '–ì–∏–±–µ–ª—å–Ω—ã–π',
  '–ê–¥—Å–∫–∏–π',
  '–ü–æ—Ç—É—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π',
  '–¢–ª–µ—é—â–∏–π',
] as const;

const NAME_SUBJECTS = [
  '–õ–∞–±–∏—Ä–∏–Ω—Ç',
  '–°–∫–ª–µ–ø',
  '–ê–ª—Ç–∞—Ä—å',
  '–ü–æ—Ä—Ç–∞–ª',
  '–†–∞–∑–ª–æ–º',
  '–ö–∞—Ç–∞–∫–æ–º–±—ã',
  '–ö—Ä–µ–ø–æ—Å—Ç—å',
  '–ì—Ä–æ—Ç',
  '–°–≤—è—Ç–∏–ª–∏—â–µ',
  '–ß–µ—Ä—Ç–æ–≥',
  '–ü–æ–¥–∑–µ–º–µ–ª—å–µ',
  '–¢—Ä–æ–Ω',
  '–ë–µ–∑–¥–Ω–∞',
  '–ò—Å—Ç–æ—á–Ω–∏–∫',
  '–ì–æ—Ä–Ω',
  '–ö—É–∑–Ω–∏—Ü–∞',
  '–£—Å—ã–ø–∞–ª—å–Ω–∏—Ü–∞',
  '–û–ø–ª–æ—Ç',
  '–ü—É—Å—Ç–æ—à—å',
  '–í–µ—Ä—à–∏–Ω–∞',
] as const;

const NAME_SUFFIXES = [
  '–¢—å–º—ã',
  '–î–µ–º–æ–Ω–æ–≤',
  '–ü–æ—Ä—á–∏',
  '–î—É—à',
  '–ö–æ—Å—Ç–µ–π',
  '–¢–µ–Ω–µ–π',
  '–û—Ç—á–∞—è–Ω–∏—è',
  '–ì–∏–±–µ–ª–∏',
  '–ü–ª–∞–º–µ–Ω–∏',
  '–•–∞–æ—Å–∞',
  '–ü—Ä–æ–∫–ª—è—Ç—å—è',
  '–ö—Ä–æ–≤–∏',
  '–°—Ç—Ä–∞—Ö–∞',
  '–ë–µ–∑—É–º–∏—è',
  '–°–∫–æ—Ä–±–∏',
  '–ó–∞–±–≤–µ–Ω–∏—è',
  '–Ø—Ä–æ—Å—Ç–∏',
  '–°–º–µ—Ä—Ç–∏',
  '–ú—Ä–∞–∫–∞',
  '–†–∞–∑—Ä—É—à–µ–Ω–∏—è',
] as const;

const NARRATIVE_TEMPLATES = [
  '–†–∞–∑–≤–µ–¥—á–∏–∫–∏ –¥–æ–Ω–µ—Å–ª–∏ –æ {place}, —Å–∫—Ä—ã—Ç–æ–º –≤ –≥–ª—É–±–∏–Ω–∞—Ö –∞–¥—Å–∫–æ–≥–æ –∏–∑–º–µ—Ä–µ–Ω–∏—è. {threat} –°–≤–µ—Ç–æ–Ω–æ—Å–Ω—ã–µ –¥–æ–ª–∂–Ω—ã {mission}, –ø–æ–∫–∞ –¢—å–º–∞ –Ω–µ –ø–æ–≥–ª–æ—Ç–∏–ª–∞ –≤—Å—ë –≤–æ–∫—Ä—É–≥.',
  '–õ–µ–≥–µ–Ω–¥—ã –ø–æ–≤–µ—Å—Ç–≤—É—é—Ç –æ {place}, –≥–¥–µ {threat} –ù–∞—à –æ—Ç—Ä—è–¥ –¥–æ–ª–∂–µ–Ω {mission} –∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∂–∏–≤—ã–º–∏.',
  '–ó–∞ —Å—Ç–µ–Ω–∞–º–∏ {place} —Ç–∞–∏—Ç—Å—è {danger}. {threat} –ì–µ—Ä–æ–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ –ø—É—Ç—å, —á—Ç–æ–±—ã {mission}.',
  '–î—Ä–µ–≤–Ω–∏–π {place} –ø—Ä–æ–±—É–¥–∏–ª—Å—è. {threat} –¢–æ–ª—å–∫–æ —Å–∞–º—ã–µ –æ—Ç–≤–∞–∂–Ω—ã–µ –°–≤–µ—Ç–æ–Ω–æ—Å–Ω—ã–µ —Å–º–æ–≥—É—Ç {mission}, –ø—Ä–µ–∂–¥–µ —á–µ–º –±—É–¥–µ—Ç —Å–ª–∏—à–∫–æ–º –ø–æ–∑–¥–Ω–æ.',
  '–¢—å–º–∞ —Å–≥—É—Å—Ç–∏–ª–∞—Å—å –Ω–∞–¥ {place}. {threat} –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —à–∞–Ω—Å ‚Äî {mission}, —Ä–∏—Å–∫—É—è –Ω–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥.',
  '–ò–∑ {place} –¥–æ–Ω–æ—Å—è—Ç—Å—è –∂—É—Ç–∫–∏–µ –∑–≤—É–∫–∏. {threat} –û—Ç—Ä—è–¥ –°–≤–µ—Ç–æ–Ω–æ—Å–Ω—ã—Ö –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–Ω–∏–∫–Ω—É—Ç—å –≤–Ω—É—Ç—Ä—å –∏ {mission}.',
] as const;

const NARRATIVE_PLACES = [
  '–¥—Ä–µ–≤–Ω–µ–º –ø–æ–¥–∑–µ–º–µ–ª—å–µ',
  '–∑–∞–±—Ä–æ—à–µ–Ω–Ω–æ–º —Å–≤—è—Ç–∏–ª–∏—â–µ –¥–µ–º–æ–Ω–æ–≤',
  '–∫–∞—Ç–∞–∫–æ–º–±–∞—Ö –ø–æ–¥ —Ä–∞–∑–≤–∞–ª–∏–Ω–∞–º–∏ —Ö—Ä–∞–º–∞',
  '–∞–¥—Å–∫–∏—Ö –ø–µ—â–µ—Ä–∞—Ö',
  '–ø—Ä–æ–∫–ª—è—Ç–æ–π –∫—Ä–µ–ø–æ—Å—Ç–∏',
  '—Ä—É–∏–Ω–∞—Ö –∞–Ω–≥–µ–ª—å—Å–∫–æ–π —Ü–∏—Ç–∞–¥–µ–ª–∏',
  '–ª–∞–±–∏—Ä–∏–Ω—Ç–µ –∏–∑ –∫–æ—Å—Ç–µ–π',
  '—Ç—Ä–æ–Ω–Ω–æ–º –∑–∞–ª–µ –¥–µ–º–æ–Ω–∏—á–µ—Å–∫–æ–≥–æ –ª–æ—Ä–¥–∞',
  '–ø—ã–ª–∞—é—â–µ–º –≥—Ä–æ—Ç–µ',
  '–ª–µ–¥—è–Ω—ã—Ö —á–µ—Ä—Ç–æ–≥–∞—Ö –º—ë—Ä—Ç–≤—ã—Ö',
] as const;

const NARRATIVE_THREATS = [
  '–û—Ä–¥—ã –Ω–µ–∂–∏—Ç–∏ –Ω–∞–≤–æ–¥–Ω–∏–ª–∏ –∫–∞–∂–¥—ã–π –∑–∞–ª.',
  '–î–µ–º–æ–Ω—ã —Å—Ç–µ—Ä–µ–≥—É—Ç –∫–∞–∂–¥—ã–π –ø—Ä–æ—Ö–æ–¥.',
  '–ê–¥—Å–∫–∏–µ –±–µ—Å—ã —É—Å—Ç—Ä–æ–∏–ª–∏ –∑–∞—Å–∞–¥—ã –Ω–∞ –≤—Å–µ—Ö –ø—É—Ç—è—Ö.',
  '–ü–æ—Ä—á–∞ —Ä–∞–∑—ä–µ–¥–∞–µ—Ç —Å–∞–º–∏ —Å—Ç–µ–Ω—ã –ø–æ–¥–∑–µ–º–µ–ª—å—è.',
  '–ë—Ä–æ–¥—è—á–∏–µ –º–æ–Ω—Å—Ç—Ä—ã –Ω–µ –¥–∞–¥—É—Ç –ø—Ä–æ–π—Ç–∏ –±–µ–∑ –±–æ—è.',
  '–¢—å–º–∞ –∑–¥–µ—Å—å –Ω–∞—Å—Ç–æ–ª—å–∫–æ –≥—É—Å—Ç–∞, —á—Ç–æ –ø–æ–≥–ª–æ—â–∞–µ—Ç —Å–≤–µ—Ç —Ñ–∞–∫–µ–ª–æ–≤.',
  '–õ–æ–≤—É—à–∫–∏ –ø–æ–¥—Å—Ç–µ—Ä–µ–≥–∞—é—Ç –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥—É.',
  '–í—Ä–µ–º—è –∏–≥—Ä–∞–µ—Ç –ø—Ä–æ—Ç–∏–≤ –≥–µ—Ä–æ–µ–≤ ‚Äî —à–∫–∞–ª–∞ —Ç—å–º—ã –Ω–µ—É–º–æ–ª–∏–º–æ –ø—Ä–æ–¥–≤–∏–≥–∞–µ—Ç—Å—è.',
] as const;

const NARRATIVE_MISSIONS = [
  '–ø—Ä–æ–±–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ –ø–æ–ª—á–∏—â–∞ –≤—Ä–∞–≥–æ–≤ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ',
  '–Ω–∞–π—Ç–∏ –∏ —É–Ω–∏—á—Ç–æ–∂–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫ –∑–ª–∞',
  '—Å–ø–∞—Å—Ç–∏ –ø–ª–µ–Ω–Ω–∏–∫–æ–≤ –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –±—É–¥–µ—Ç —Å–ª–∏—à–∫–æ–º –ø–æ–∑–¥–Ω–æ',
  '–¥–æ–±—ã—Ç—å –¥—Ä–µ–≤–Ω–∏–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –∏ –≤—ã–±—Ä–∞—Ç—å—Å—è –∏–∑ –ø–æ–¥–∑–µ–º–µ–ª—å—è',
  '–æ—á–∏—Å—Ç–∏—Ç—å —ç—Ç–æ –º–µ—Å—Ç–æ –æ—Ç —Å–∫–≤–µ—Ä–Ω—ã',
  '–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∏—Ç—É–∞–ª, –ø–æ–∫–∞ –≤—Ä–∞—Ç–∞ –Ω–µ –æ—Ç–∫—Ä—ã–ª–∏—Å—å –ø–æ–ª–Ω–æ—Å—Ç—å—é',
  '—É–Ω–∏—á—Ç–æ–∂–∏—Ç—å –ø–µ—á–∞—Ç–∏ –ø–æ—Ä—á–∏ –∏ –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –∑–∞–∫–ª—é—á—ë–Ω–Ω–æ–≥–æ',
  '—Å–æ–±—Ä–∞—Ç—å –∫–ª—é—á–∏ –∏ –æ—Ç–ø–µ—Ä–µ—Ç—å –≤—Ä–∞—Ç–∞ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ª',
] as const;

// –í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∞–π–ª—ã
const ALL_TILES: MapTile[] = [];
for (let n = 1; n <= 8; n++) {
  ALL_TILES.push({ id: `${n}A`, side: 'A', number: n });
  ALL_TILES.push({ id: `${n}B`, side: 'B', number: n });
}

// ============================================================
// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–µ–ª–µ–π
// ============================================================

interface ObjectiveTemplate {
  type: ObjectiveType;
  icon: string;
  generateTitle: (rng: SeededRandom) => string;
  generateDescription: (
    rng: SeededRandom,
    difficulty: DifficultyLevel,
  ) => string;
  /** –í–µ—Å ‚Äî —á–µ–º –±–æ–ª—å—à–µ, —Ç–µ–º —á–∞—â–µ –≤—ã–ø–∞–¥–∞–µ—Ç */
  weight: number;
  /** –¢–∏–ø—ã, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ –Ω–µ —Å–æ–≤–º–µ—Å—Ç–∏–º */
  incompatible?: ObjectiveType[];
}

const OBJECTIVE_TEMPLATES: ObjectiveTemplate[] = [
  {
    type: 'COLLECT_ITEMS',
    icon: 'üîÆ',
    weight: 10,
    generateTitle: () => '–°–æ–±–µ—Ä–∏—Ç–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã',
    generateDescription: (rng, diff) => {
      const count =
        diff === 'easy' ? 2 : diff === 'normal' ? 3 : diff === 'hard' ? 4 : 5;
      const items = rng.pick([
        '–æ—Å–∫–æ–ª–∫–æ–≤ –∫—Ä–∏—Å—Ç–∞–ª–ª–∞',
        '—Å–≤—è—â–µ–Ω–Ω—ã—Ö —Ä–µ–ª–∏–∫–≤–∏–π',
        '–º–∞–≥–∏—á–µ—Å–∫–∏—Ö —Å–≤–∏—Ç–∫–æ–≤',
        '–∫–ª—é—á–µ–π –æ—Ç –∞–ª—Ç–∞—Ä—è',
        '—Ä—É–Ω –¥—Ä–µ–≤–Ω–∏—Ö',
      ]);
      return `–°–æ–±–µ—Ä–∏—Ç–µ ${count} ${items}, —Ä–∞–∑–±—Ä–æ—Å–∞–Ω–Ω—ã—Ö –ø–æ –ø–æ–¥–∑–µ–º–µ–ª—å—é. –ö–∞–∂–¥—ã–π –ø—Ä–µ–¥–º–µ—Ç –æ–±–æ–∑–Ω–∞—á–µ–Ω —Ü–≤–µ—Ç–Ω—ã–º –∂–µ—Ç–æ–Ω–æ–º —Ü–µ–ª–∏. –ì–µ—Ä–æ–π, –Ω–∞—Ö–æ–¥—è—â–∏–π—Å—è –≤ –∑–æ–Ω–µ —Å –∂–µ—Ç–æ–Ω–æ–º, –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å 1 –û–î, —á—Ç–æ–±—ã –ø–æ–¥–æ–±—Ä–∞—Ç—å –µ–≥–æ (–ø–æ–ª—É—á–∞–µ—Ç 5 –æ–ø—ã—Ç–∞).`;
    },
  },
  {
    type: 'ACTIVATE_SWITCHES',
    icon: 'üîë',
    weight: 8,
    generateTitle: () => '–û—Ç–∫—Ä–æ–π—Ç–µ –≤—Ä–∞—Ç–∞',
    generateDescription: (_rng, diff) => {
      const count = diff === 'easy' ? 2 : diff === 'normal' ? 2 : 3;
      return `–ù–∞–∂–º–∏—Ç–µ ${count} –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è, –æ–±–æ–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Ü–≤–µ—Ç–Ω—ã–º–∏ –∂–µ—Ç–æ–Ω–∞–º–∏ —Ü–µ–ª–µ–π, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∑–∞–ø–µ—á–∞—Ç–∞–Ω–Ω—ã–µ –≤—Ä–∞—Ç–∞ (–¥–≤–µ—Ä—å —Å –±–µ–ª—ã–º –∫–æ–Ω—Ç—É—Ä–æ–º). –ì–µ—Ä–æ–π –≤ –∑–æ–Ω–µ —Å –∂–µ—Ç–æ–Ω–æ–º —Ç—Ä–∞—Ç–∏—Ç 1 –û–î –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ (–ø–æ–ª—É—á–∞–µ—Ç 3 –æ–ø—ã—Ç–∞). –í—Ä–∞—Ç–∞ –±–ª–æ–∫–∏—Ä—É—é—Ç –ø—Ä—è–º—É—é –≤–∏–¥–∏–º–æ—Å—Ç—å, –Ω–æ –≤—Ä–∞–≥–∏ –º–æ–≥—É—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ –Ω–∏—Ö.`;
    },
  },
  {
    type: 'ESCORT_NPC',
    icon: 'üõ°Ô∏è',
    weight: 6,
    incompatible: ['SURVIVE_WAVES', 'RACE_TO_EXIT'],
    generateTitle: () => '–ó–∞—â–∏—Ç–∏—Ç–µ —Å–æ—é–∑–Ω–∏–∫–∞',
    generateDescription: (rng, diff) => {
      const npc = rng.pick([
        '–∑–∞–∫–ª–∏–Ω–∞—Ç–µ–ª—è',
        '–∂—Ä–µ—Ü–∞',
        '—Ä–∞–Ω–µ–Ω–æ–≥–æ –∞–Ω–≥–µ–ª–∞',
        '–ø–ª–µ–Ω–Ω–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞',
      ]);
      const hp =
        diff === 'easy' ? 10 : diff === 'normal' ? 8 : diff === 'hard' ? 6 : 5;
      return `–ó–∞—â–∏—Ç–∏—Ç–µ ${npc} –∏ –¥–æ–≤–µ–¥–∏—Ç–µ –¥–æ —Å–µ—Ä–æ–≥–æ –∂–µ—Ç–æ–Ω–∞ —Ü–µ–ª–∏. NPC –¥–≤–∏–∂–µ—Ç—Å—è –Ω–∞ 2 –∑–æ–Ω—ã –∫ —Ü–µ–ª–∏ –≤ –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã –≥–µ—Ä–æ–µ–≤ (–Ω–∞—á–∏–Ω–∞—è —Å–æ 2-–≥–æ —Ä–∞—É–Ω–¥–∞). NPC –Ω–µ –º–æ–∂–µ—Ç –ø–æ–∫–∏–Ω—É—Ç—å –∑–æ–Ω—É —Å –≤—Ä–∞–≥–æ–º. –ó–¥–æ—Ä–æ–≤—å–µ NPC: ${hp}, –∑–∞—â–∏—Ç–∞: 2 —Å–∏–Ω–∏—Ö –∫—É–±–∏–∫–∞. –ü—Ä–∏ –≥–∏–±–µ–ª–∏ NPC ‚Äî –ø–æ—Ä–∞–∂–µ–Ω–∏–µ.`;
    },
  },
  {
    type: 'FORGE_ARTIFACT',
    icon: 'üî®',
    weight: 6,
    incompatible: ['COLLECT_ITEMS'],
    generateTitle: () => '–í—ã–∫—É–π—Ç–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç',
    generateDescription: (_rng, diff) => {
      const count = diff === 'easy' ? 2 : 3;
      return `–°–æ–±–µ—Ä–∏—Ç–µ ${count} –æ—Å–∫–æ–ª–∫–∞, –æ–±–æ–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Ü–≤–µ—Ç–Ω—ã–º–∏ –∂–µ—Ç–æ–Ω–∞–º–∏ —Ü–µ–ª–µ–π (5 –æ–ø—ã—Ç–∞ –∑–∞ –∫–∞–∂–¥—ã–π). –ó–∞—Ç–µ–º –≤—Å–µ –≥–µ—Ä–æ–∏ —Å –æ—Å–∫–æ–ª–∫–∞–º–∏ –¥–æ–ª–∂–Ω—ã —Å–æ–±—Ä–∞—Ç—å—Å—è –≤ –∑–æ–Ω–µ –∫—É–∑–Ω–∏ (—Å–µ—Ä—ã–π –∂–µ—Ç–æ–Ω —Ü–µ–ª–∏) –∏ –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å 1 –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞.`;
    },
  },
  {
    type: 'DESTROY_TARGETS',
    icon: 'üíé',
    weight: 9,
    generateTitle: (rng) =>
      rng.pick([
        '–£–Ω–∏—á—Ç–æ–∂—å—Ç–µ –∫—Ä–∏—Å—Ç–∞–ª–ª—ã –≥—Ä–µ—Ö–∞',
        '–†–∞–∑—Ä—É—à—å—Ç–µ –ø–µ—á–∞—Ç–∏ –ø–æ—Ä—á–∏',
        '–°–æ–∂–≥–∏—Ç–µ —Ç–æ—Ç–µ–º—ã —Ç—å–º—ã',
      ]),
    generateDescription: (rng, diff) => {
      const count =
        diff === 'easy' ? 3 : diff === 'normal' ? 4 : diff === 'hard' ? 5 : 6;
      const targets = rng.pick([
        '–∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ –≥—Ä–µ—Ö–∞',
        '–ø–µ—á–∞—Ç–µ–π –ø–æ—Ä—á–∏',
        '—Ç–æ—Ç–µ–º–æ–≤ —Ç—å–º—ã',
        '—è–∫–æ—Ä–µ–π —Å–∫–≤–µ—Ä–Ω—ã',
      ]);
      return `–£–Ω–∏—á—Ç–æ–∂—å—Ç–µ ${count} ${targets}, –æ–±–æ–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –∂–µ—Ç–æ–Ω–∞–º–∏ —Ü–µ–ª–µ–π. –ì–µ—Ä–æ–π –≤ –∑–æ–Ω–µ —Å –∂–µ—Ç–æ–Ω–æ–º —Ç—Ä–∞—Ç–∏—Ç 1 –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è (–ø–æ–ª—É—á–∞–µ—Ç 5 –æ–ø—ã—Ç–∞). –ö–∞–∫ —Ç–æ–ª—å–∫–æ –≤—Å–µ –∂–µ—Ç–æ–Ω—ã —É–±—Ä–∞–Ω—ã ‚Äî –∑–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞.`;
    },
  },
  {
    type: 'HUNT_MONSTERS',
    icon: 'üêâ',
    weight: 8,
    generateTitle: () => '–û—Ö–æ—Ç–∞ –Ω–∞ –±—Ä–æ–¥—è—á–∏—Ö –∑–≤–µ—Ä–µ–π',
    generateDescription: (_rng, diff) => {
      const count =
        diff === 'easy' ? 2 : diff === 'normal' ? 3 : diff === 'hard' ? 4 : 4;
      return `–£–±–µ–π—Ç–µ ${count} –æ—Å–æ–±—ã—Ö –±—Ä–æ–¥—è—á–∏—Ö –º–æ–Ω—Å—Ç—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∑–∞–ª–æ–≤ —Å –∂–µ—Ç–æ–Ω–∞–º–∏ –ø–æ—Ä—á–∏. –ö–∞–∂–¥—ã–π –∑–∞–ª —Å –∂–µ—Ç–æ–Ω–æ–º –ø–æ—Ä—á–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–æ—Ä–æ–∂–¥–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –±—Ä–æ–¥—è—á–µ–≥–æ –º–æ–Ω—Å—Ç—Ä–∞.`;
    },
  },
  {
    type: 'DEFEAT_BOSS',
    icon: 'üëë',
    weight: 5,
    generateTitle: (rng) =>
      rng.pick([
        '–ü–æ–±–µ–¥–∏—Ç–µ —Å—Ç—Ä–∞–∂–∞',
        '–ù–∏–∑–≤–µ—Ä–≥–Ω–∏—Ç–µ –ø–æ–≤–µ–ª–∏—Ç–µ–ª—è',
        '–£–Ω–∏—á—Ç–æ–∂—å—Ç–µ –≤–æ–∂–∞–∫–∞',
      ]),
    generateDescription: (rng, _diff) => {
      const bossType = rng.pick([
        '–¥–µ–º–æ–Ω–∏—á–µ—Å–∫–æ–≥–æ —Å—Ç—Ä–∞–∂–∞',
        '–ø–æ—Ä–æ—á–Ω–æ–≥–æ –∞—Ä—Ö–∞–Ω–≥–µ–ª–∞',
        '–ø–æ–≤–µ–ª–∏—Ç–µ–ª—è –Ω–µ–∂–∏—Ç–∏',
        '–∂–Ω–µ—Ü–∞ –¥—É—à',
      ]);
      return `–ù–∞–π–¥–∏—Ç–µ –ø—É—Ç—å –∫ –∑–∞–ª—É –≤–æ–∂–∞–∫–∞ –∏ –ø–æ–±–µ–¥–∏—Ç–µ ${bossType}. –í–æ–∂–∞–∫ –Ω–µ—É—è–∑–≤–∏–º, –ø–æ–∫–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ. –ö–æ–≥–¥–∞ –≥–µ—Ä–æ–π –≤—Ö–æ–¥–∏—Ç –≤ –∑–∞–ª –≤–æ–∂–∞–∫–∞ ‚Äî –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –±–∏—Ç–≤–∞. –í—Å–µ –≥–µ—Ä–æ–∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç –∑–¥–æ—Ä–æ–≤—å–µ –∏ –º–∞–Ω—É –¥–æ –º–∞–∫—Å–∏–º—É–º–∞.`;
    },
  },
  {
    type: 'COLLECT_SOULS',
    icon: 'üëª',
    weight: 7,
    incompatible: ['COLLECT_ITEMS', 'FORGE_ARTIFACT'],
    generateTitle: () => '–°–æ–±–µ—Ä–∏—Ç–µ –¥—É—à–∏',
    generateDescription: (_rng, diff) => {
      const perPlayer =
        diff === 'easy'
          ? 7
          : diff === 'normal'
            ? 10
            : diff === 'hard'
              ? 12
              : 15;
      return `–°–æ–±–µ—Ä–∏—Ç–µ ${perPlayer} –¥—É—à –∑–∞ –∫–∞–∂–¥–æ–≥–æ –≥–µ—Ä–æ—è. –ì–µ—Ä–æ–∏ –ø–æ–ª—É—á–∞—é—Ç 1 –¥—É—à—É –∑–∞ —É–±–∏—Ç–æ–≥–æ –ø—Ä–∏—Å–ø–µ—à–Ω–∏–∫–∞/–ª–∏–¥–µ—Ä–∞, 3 –¥—É—à–∏ –∑–∞ –±—Ä–æ–¥—è—á–µ–≥–æ –º–æ–Ω—Å—Ç—Ä–∞. –¶–≤–µ—Ç–Ω—ã–µ –∂–µ—Ç–æ–Ω—ã —Ü–µ–ª–µ–π (–ø–ª–µ–Ω—ë–Ω–Ω—ã–µ –¥—É—à–∏) –¥–∞—é—Ç 5 –¥—É—à –ø—Ä–∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–∏ (1 –¥–µ–π—Å—Ç–≤–∏–µ, +5 –æ–ø—ã—Ç–∞). –ö–æ–≥–¥–∞ –Ω–∞–±—Ä–∞–Ω–æ –Ω—É–∂–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –≥–µ—Ä–æ–∏ –º–æ–≥—É—Ç –≤—ã–π—Ç–∏ —á–µ—Ä–µ–∑ –≤—Ä–∞—Ç–∞ (—Å–µ—Ä—ã–π –∂–µ—Ç–æ–Ω —Ü–µ–ª–∏).`;
    },
  },
  {
    type: 'TIMED_COLLECTION',
    icon: '‚è≥',
    weight: 6,
    incompatible: ['SURVIVE_WAVES', 'RACE_TO_EXIT'],
    generateTitle: () => '–°–æ–±–µ—Ä–∏—Ç–µ –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏',
    generateDescription: (_rng, diff) => {
      const tokens =
        diff === 'easy' ? 5 : diff === 'normal' ? 3 : diff === 'hard' ? 3 : 2;
      return `–°–æ–±–µ—Ä–∏—Ç–µ –≤—Å–µ –¥—É—Ö-–∫–ª—é—á–∏ –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –æ–Ω–∏ –∏—Å—á–µ–∑–Ω—É—Ç. –ù–∞ –∫–∞–∂–¥–æ–º –∂–µ—Ç–æ–Ω–µ —Ü–µ–ª–∏ –ª–µ–∂–∏—Ç ${tokens} –∂–µ—Ç–æ–Ω–æ–≤ –≤—Ä–µ–º–µ–Ω–∏. –í –∫–∞–∂–¥—É—é —Ñ–∞–∑—É —Ç—å–º—ã —É–±–∏—Ä–∞–π—Ç–µ 1 –∂–µ—Ç–æ–Ω –≤—Ä–µ–º–µ–Ω–∏. –ï—Å–ª–∏ –∂–µ—Ç–æ–Ω–æ–≤ –≤—Ä–µ–º–µ–Ω–∏ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å ‚Äî –∫–ª—é—á –∏—Å—á–µ–∑–∞–µ—Ç –∏ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–∏–≥—Ä–∞–Ω–æ. –ì–µ—Ä–æ–π —Ç—Ä–∞—Ç–∏—Ç 1 –¥–µ–π—Å—Ç–≤–∏–µ, —á—Ç–æ–±—ã –ø–æ–¥–æ–±—Ä–∞—Ç—å –∫–ª—é—á (+8 –æ–ø—ã—Ç–∞ –≤—Å–µ–º).`;
    },
  },
  {
    type: 'CLOSE_RIFT',
    icon: 'üåÄ',
    weight: 7,
    generateTitle: () => '–ó–∞–∫—Ä–æ–π—Ç–µ —Ä–∞–∑–ª–æ–º',
    generateDescription: () =>
      '–ù–∞–π–¥–∏—Ç–µ –º–∞–≥–∏—á–µ—Å–∫–∏–π —Å–≤–∏—Ç–æ–∫ (—Ü–≤–µ—Ç–Ω–æ–π –∂–µ—Ç–æ–Ω —Ü–µ–ª–∏, 1 –û–î –¥–ª—è –ø–æ–¥–±–æ—Ä–∞, +5 –æ–ø—ã—Ç–∞ –≤—Å–µ–º –≥–µ—Ä–æ—è–º). –ó–∞—Ç–µ–º –≥–µ—Ä–æ–π —Å–æ —Å–≤–∏—Ç–∫–æ–º –¥–æ–ª–∂–µ–Ω –¥–æ–±—Ä–∞—Ç—å—Å—è –¥–æ —Ä–∞–∑–ª–æ–º–∞ (—Å–µ—Ä—ã–π –∂–µ—Ç–æ–Ω —Ü–µ–ª–∏) –∏ –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å 1 –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –µ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è.',
  },
  // –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∫–∏
  {
    type: 'DEFEND_ZONE',
    icon: 'üè∞',
    weight: 6,
    incompatible: ['ESCORT_NPC', 'RACE_TO_EXIT'],
    generateTitle: () => '–£–¥–µ—Ä–∂–∏—Ç–µ –ø–æ–∑–∏—Ü–∏—é',
    generateDescription: (_rng, diff) => {
      const rounds =
        diff === 'easy' ? 4 : diff === 'normal' ? 5 : diff === 'hard' ? 6 : 7;
      return `–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –∞–ª—Ç–∞—Ä—å (—Å–µ—Ä—ã–π –∂–µ—Ç–æ–Ω —Ü–µ–ª–∏) –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ ${rounds} —Ä–∞—É–Ω–¥–æ–≤. –í –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ä–∞—É–Ω–¥–∞ –±—Ä–æ—Å—å—Ç–µ –∫—É–±–∏–∫ —Å—É–º—Ä–∞–∫–∞: –ø—Ä–∏ –≤—ã–ø–∞–¥–µ–Ω–∏–∏ —Å–∏–º–≤–æ–ª–∞ —Ç—å–º—ã —Ä–∞–∑—ã–≥—Ä—ã–≤–∞–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –æ—Ç—Ä—è–¥–∞ –≤ –±–ª–∏–∂–∞–π—à–µ–π –∑–æ–Ω–µ –ø–æ—è–≤–ª–µ–Ω–∏—è. –•–æ—Ç—è –±—ã 1 –≥–µ—Ä–æ–π –¥–æ–ª–∂–µ–Ω –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ –∑–æ–Ω–µ –∞–ª—Ç–∞—Ä—è –≤ –∫–æ–Ω—Ü–µ –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã –≥–µ—Ä–æ–µ–≤, –∏–Ω–∞—á–µ —Å—á—ë—Ç—á–∏–∫ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è.`;
    },
  },
  {
    type: 'SURVIVE_WAVES',
    icon: 'üåä',
    weight: 5,
    incompatible: ['ESCORT_NPC', 'TIMED_COLLECTION'],
    generateTitle: () => '–í—ã–∂–∏–≤–∏—Ç–µ –≤ –≤–æ–ª–Ω–∞—Ö',
    generateDescription: (_rng, diff) => {
      const waves =
        diff === 'easy' ? 3 : diff === 'normal' ? 4 : diff === 'hard' ? 5 : 6;
      return `–í—ã–¥–µ—Ä–∂–∏—Ç–µ ${waves} –≤–æ–ª–Ω –Ω–∞—Ä–∞—Å—Ç–∞—é—â–∏—Ö –≤—Ä–∞–≥–æ–≤. –í –∫–æ–Ω—Ü–µ –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã —Ç—å–º—ã —Ä–∞–∑—ã–≥—Ä—ã–≤–∞–µ—Ç—Å—è –≤–æ–ª–Ω–∞: –ø–æ—è–≤–ª–µ–Ω–∏–µ –æ—Ç—Ä—è–¥–æ–≤ –≤–æ –≤—Å–µ—Ö –∑–æ–Ω–∞—Ö –ø–æ—è–≤–ª–µ–Ω–∏—è —Å +1 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –ø—Ä–∏—Å–ø–µ—à–Ω–∏–∫–æ–º –∑–∞ –∫–∞–∂–¥—É—é –ø—Ä–æ–π–¥–µ–Ω–Ω—É—é –≤–æ–ª–Ω—É. –ü–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–æ–ª–Ω—ã ‚Äî –ø–æ–±–µ–¥–∞. –ö–∞–∂–¥–∞—è –≤–æ–ª–Ω–∞ –¥–∞—ë—Ç +3 –æ–ø—ã—Ç–∞ –≤—Å–µ–º –≥–µ—Ä–æ—è–º.`;
    },
  },
  {
    type: 'PURIFY_CORRUPTION',
    icon: '‚ú®',
    weight: 7,
    generateTitle: () => '–û—á–∏—Å—Ç–∏—Ç–µ —Å–∫–≤–µ—Ä–Ω—É',
    generateDescription: (_rng, diff) => {
      const count =
        diff === 'easy' ? 3 : diff === 'normal' ? 4 : diff === 'hard' ? 5 : 6;
      return `–û—á–∏—Å—Ç–∏—Ç–µ ${count} –∑–æ–Ω –ø–æ—Ä—á–∏, –æ–±–æ–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –∂–µ—Ç–æ–Ω–∞–º–∏ –ø–æ—Ä—á–∏. –ì–µ—Ä–æ–π –≤ –∑–æ–Ω–µ —Å –∂–µ—Ç–æ–Ω–æ–º —Ç—Ä–∞—Ç–∏—Ç 1 –¥–µ–π—Å—Ç–≤–∏–µ –∏ –±—Ä–æ—Å–∞–µ—Ç 1 –∫—É–±–∏–∫ —Å—É–º—Ä–∞–∫–∞: –ø—Ä–∏ —Å–∏–º–≤–æ–ª–µ —Ç—å–º—ã –≥–µ—Ä–æ–π –ø–æ–ª—É—á–∞–µ—Ç 1 —Ä–∞–Ω–µ–Ω–∏–µ, –ø—Ä–∏ —Å–∏–º–≤–æ–ª–µ –ø–æ—Ä—á–∏ ‚Äî –ø–æ–º–µ—â–∞–µ—Ç –∂–µ—Ç–æ–Ω –ø–æ—Ä—á–∏ –Ω–∞ —Å–≤–æ—é –ø–∞–Ω–µ–ª—å. –û—á–∏—â–µ–Ω–Ω–∞—è –∑–æ–Ω–∞ –¥–∞—ë—Ç +5 –æ–ø—ã—Ç–∞ –≤—Å–µ–º –≥–µ—Ä–æ—è–º.`;
    },
  },
  {
    type: 'RACE_TO_EXIT',
    icon: 'üèÉ',
    weight: 5,
    incompatible: ['DEFEND_ZONE', 'ESCORT_NPC', 'TIMED_COLLECTION'],
    generateTitle: () => '–ì–æ–Ω–∫–∞ –∫ –≤—ã—Ö–æ–¥—É',
    generateDescription: (_rng, diff) => {
      const rounds =
        diff === 'easy' ? 12 : diff === 'normal' ? 10 : diff === 'hard' ? 8 : 6;
      return `–í—Å–µ –≥–µ—Ä–æ–∏ –¥–æ–ª–∂–Ω—ã –¥–æ–±—Ä–∞—Ç—å—Å—è –¥–æ –≤—ã—Ö–æ–¥–∞ (—Å–µ—Ä—ã–π –∂–µ—Ç–æ–Ω —Ü–µ–ª–∏) –∑–∞ ${rounds} —Ä–∞—É–Ω–¥–æ–≤. –í—ã—Ö–æ–¥ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ–º –∫–æ–Ω—Ü–µ –ø–æ–¥–∑–µ–º–µ–ª—å—è. –ì–µ—Ä–æ–π –≤ –∑–æ–Ω–µ –≤—ã—Ö–æ–¥–∞ —Ç—Ä–∞—Ç–∏—Ç 1 –û–î –¥–ª—è –ø–æ–±–µ–≥–∞. –ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã 1 –≥–µ—Ä–æ–π –Ω–µ —É—Å–ø–µ–µ—Ç –≤—ã–±—Ä–∞—Ç—å—Å—è ‚Äî –ø–æ—Ä–∞–∂–µ–Ω–∏–µ. –ö–∞–∂–¥—ã–µ 2 —Ä–∞—É–Ω–¥–∞ —Ä–∞–∑—ã–≥—Ä—ã–≤–∞–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –æ—Ç—Ä—è–¥–∞ –≤ —Å–ª—É—á–∞–π–Ω–æ–π –∑–æ–Ω–µ –ø–æ—è–≤–ª–µ–Ω–∏—è.`;
    },
  },
  {
    type: 'RITUAL_SEQUENCE',
    icon: 'üïØÔ∏è',
    weight: 5,
    incompatible: ['RACE_TO_EXIT', 'SURVIVE_WAVES'],
    generateTitle: () => '–†–∏—Ç—É–∞–ª –∏–∑–≥–Ω–∞–Ω–∏—è',
    generateDescription: (_rng, diff) => {
      const count =
        diff === 'easy' ? 3 : diff === 'normal' ? 3 : diff === 'hard' ? 4 : 5;
      return `–ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ ${count} –∞–ª—Ç–∞—Ä—è –≤ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ. –ê–ª—Ç–∞—Ä–∏ –æ–±–æ–∑–Ω–∞—á–µ–Ω—ã –ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∂–µ—Ç–æ–Ω–∞–º–∏ —Ü–µ–ª–µ–π. –ì–µ—Ä–æ–π —Ç—Ä–∞—Ç–∏—Ç 1 –¥–µ–π—Å—Ç–≤–∏–µ –≤ –∑–æ–Ω–µ –∞–ª—Ç–∞—Ä—è –¥–ª—è –µ–≥–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏. –ï—Å–ª–∏ –∞–ª—Ç–∞—Ä—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –Ω–µ –≤ –ø–æ—Ä—è–¥–∫–µ –æ—á–µ—Ä–µ–¥–∏ ‚Äî –≤—Å–µ –∞–ª—Ç–∞—Ä–∏ —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –∏ –Ω—É–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å –∑–∞–Ω–æ–≤–æ. –ü—Ä–∏ –∫–∞–∂–¥–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –≤—Å–µ –≥–µ—Ä–æ–∏ –ø–æ–ª—É—á–∞—é—Ç +4 –æ–ø—ã—Ç–∞.`;
    },
  },
];

// ============================================================
// –û—Å–æ–±—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (–º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã)
// ============================================================

interface SpecialRuleTemplate {
  name: string;
  icon: string;
  generateDescription: (
    rng: SeededRandom,
    difficulty: DifficultyLevel,
  ) => string;
  /** –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø–æ—è–≤–ª–µ–Ω–∏—è (0-1) */
  chance: number;
}

const SPECIAL_RULE_TEMPLATES: SpecialRuleTemplate[] = [
  {
    name: '–†–∞–∑–ª–æ–º—ã –≤ —ç—Ñ–∏—Ä–µ',
    icon: 'üåå',
    chance: 0.3,
    generateDescription: () =>
      '–í—Ä–∞–≥–∏ –º–æ–≥—É—Ç —Å–≤–æ–±–æ–¥–Ω–æ –ø–µ—Ä–µ–¥–≤–∏–≥–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ –∑–∞–∫—Ä—ã—Ç—ã–µ –¥–≤–µ—Ä–∏. –ó–∞–∫—Ä—ã—Ç—ã–µ –¥–≤–µ—Ä–∏ –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –±–ª–æ–∫–∏—Ä—É—é—Ç –ø—Ä—è–º—É—é –≤–∏–¥–∏–º–æ—Å—Ç—å.',
  },
  {
    name: '–¢—å–º–∞ —Å–≥—É—â–∞–µ—Ç—Å—è',
    icon: 'üåë',
    chance: 0.35,
    generateDescription: (_rng, diff) => {
      const extra = diff === 'hard' || diff === 'nightmare' ? 2 : 1;
      return `–®–∫–∞–ª–∞ —Ç—å–º—ã –ø—Ä–æ–¥–≤–∏–≥–∞–µ—Ç—Å—è –Ω–∞ ${extra} –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é —è—á–µ–π–∫—É –∑–∞ –∫–∞–∂–¥—ã–µ 3 —Ä–∞—É–Ω–¥–∞. –ö–∞–∂–¥—ã–π –≥–µ—Ä–æ–π –≤ —Å–≤–µ—Ç–ª–æ–π –∑–æ–Ω–µ –ø–æ–ª—É—á–∞–µ—Ç -1 –∫ –∞—Ç–∞–∫–µ.`;
    },
  },
  {
    name: '–ü—Ä–æ–∫–ª—è—Ç–æ–µ –æ—Ä—É–∂–∏–µ',
    icon: '‚öîÔ∏è',
    chance: 0.2,
    generateDescription: () =>
      '–í –Ω–∞—á–∞–ª–µ –∏–≥—Ä—ã –æ–¥–∏–Ω –≥–µ—Ä–æ–π (–ø–æ –≤—ã–±–æ—Ä—É) –ø–æ–ª—É—á–∞–µ—Ç ¬´–û–≥—Ä–æ–º–Ω—ã–π —á—É–¥–æ–≤–∏—â–Ω—ã–π –º–µ—á¬ª –∫–∞–∫ –Ω–∞—á–∞–ª—å–Ω–æ–µ –æ—Ä—É–∂–∏–µ. –í–ª–∞–¥–µ–ª–µ—Ü –ø–æ–ª—É—á–∞–µ—Ç 1/2/3 —Ä–∞–Ω–µ–Ω–∏—è –≤ –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã –≥–µ—Ä–æ–µ–≤ (–Ω–∞—Ä–∞—Å—Ç–∞–µ—Ç –∫–∞–∂–¥—ã–π —Ä–∞—É–Ω–¥). –ü–æ—Å–ª–µ 4 —Ä–∞—É–Ω–¥–æ–≤ –ø–æ–¥—Ä—è–¥ ‚Äî –ø–æ—Ä–∞–∂–µ–Ω–∏–µ. –ú–µ—á –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –¥—Ä—É–≥–æ–º—É –≥–µ—Ä–æ—é –¥–µ–π—Å—Ç–≤–∏–µ–º –æ–±–º–µ–Ω–∞ (—Å—á—ë—Ç—á–∏–∫ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è).',
  },
  {
    name: '–ú–∞–≥–∏—á–µ—Å–∫–∏–µ –ø–µ—Ä–µ—Ö–æ–¥—ã',
    icon: 'üö™',
    chance: 0.25,
    generateDescription: () =>
      '–§—Ä–∞–≥–º–µ–Ω—Ç—ã –ø–æ–ª—è –Ω–µ —Å–æ–µ–¥–∏–Ω–µ–Ω—ã –Ω–∞–ø—Ä—è–º—É—é. –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –º–µ–∂–¥—É –Ω–∏–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∂–µ—Ç–æ–Ω—ã —Ü–µ–ª–µ–π (–º–∞–≥–∏—á–µ—Å–∫–∏–µ –ø–µ—Ä–µ—Ö–æ–¥—ã). –ì–µ—Ä–æ–π —Ç—Ä–∞—Ç–∏—Ç 1 –û–î –≤ –∑–æ–Ω–µ —Å –∂–µ—Ç–æ–Ω–æ–º, —á—Ç–æ–±—ã –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å—Å—è –∫ –ª—é–±–æ–º—É –¥—Ä—É–≥–æ–º—É –∂–µ—Ç–æ–Ω—É. –û—Ç—Ä—è–¥—ã –∏ –±—Ä–æ–¥—è—á–∏–µ –º–æ–Ω—Å—Ç—Ä—ã —Ç–∞–∫–∂–µ –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ—Ö–æ–¥—ã.',
  },
  {
    name: '–ù–∞—Ä–∞—Å—Ç–∞—é—â–∞—è –ø–æ—Ä—á–∞',
    icon: '‚ò†Ô∏è',
    chance: 0.3,
    generateDescription: (_rng, diff) => {
      const count = diff === 'nightmare' ? 3 : diff === 'hard' ? 2 : 1;
      return `–í –∫–æ–Ω—Ü–µ –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã —Ç—å–º—ã –ø–æ–º–µ—â–∞–π—Ç–µ ${count} –∂–µ—Ç–æ–Ω(–∞) –ø–æ—Ä—á–∏ –≤ —Å–ª—É—á–∞–π–Ω—É—é –∑–æ–Ω—É (–±—Ä–æ—Å—å—Ç–µ –∫—É–±–∏–∫ —Å—É–º—Ä–∞–∫–∞). –ì–µ—Ä–æ–π –≤ –∑–æ–Ω–µ —Å –ø–æ—Ä—á–µ–π –ø–æ–ª—É—á–∞–µ—Ç 1 —Ä–∞–Ω–µ–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–µ —Å–≤–æ–µ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏. –ñ–µ—Ç–æ–Ω –ø–æ—Ä—á–∏ –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ–º (1 –¥–µ–π—Å—Ç–≤–∏–µ).`;
    },
  },
  {
    name: '–ê–¥—Å–∫–∏–µ –ª–æ–≤—É—à–∫–∏',
    icon: 'ü™§',
    chance: 0.25,
    generateDescription: () =>
      '–ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–∞–∂–¥–æ–≥–æ –Ω–æ–≤–æ–≥–æ –∑–∞–ª–∞ –±—Ä–æ—Å—å—Ç–µ –∫—É–±–∏–∫ —Å—É–º—Ä–∞–∫–∞. –ü—Ä–∏ —Å–∏–º–≤–æ–ª–µ —Ç—å–º—ã —Ä–∞–∑–º–µ—Å—Ç–∏—Ç–µ –∂–µ—Ç–æ–Ω –ª–æ–≤—É—à–∫–∏ (–∫–∞–ø–∫–∞–Ω –∏–ª–∏ –ª–æ–≤—É—à–∫–∞ —Å –∫–æ–ª—å—è–º–∏, –ø–æ –≤—ã–±–æ—Ä—É) –≤ —ç—Ç–æ–º –∑–∞–ª–µ –≤ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫ –æ–±—ã—á–Ω—ã–º —ç—Ñ—Ñ–µ–∫—Ç–∞–º.',
  },
  {
    name: '–¢–µ–Ω—å –ø—Ä–µ—Å–ª–µ–¥—É–µ—Ç',
    icon: 'üëÅÔ∏è',
    chance: 0.2,
    generateDescription: () =>
      '–í –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã –≤—Ä–∞–≥–æ–≤, –±—Ä–æ–¥—è—á–∏–π –º–æ–Ω—Å—Ç—Ä (–µ—Å–ª–∏ –µ—Å—Ç—å –Ω–∞ –ø–æ–ª–µ) –ø–æ–ª—É—á–∞–µ—Ç +1 –û–î –¥–≤–∏–∂–µ–Ω–∏—è –∏ –≤—Å–µ–≥–¥–∞ –¥–≤–∏–∂–µ—Ç—Å—è –∫ –≥–µ—Ä–æ—é —Å –Ω–∞–∏–º–µ–Ω—å—à–∏–º –∑–¥–æ—Ä–æ–≤—å–µ–º.',
  },
  {
    name: '–ñ–µ—Ä—Ç–≤–∞ —Ç—å–º—ã',
    icon: 'üíÄ',
    chance: 0.2,
    generateDescription: () =>
      '–í –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ 3-–≥–æ —Ä–∞—É–Ω–¥–∞ –∫–∞–∂–¥—ã–π –≥–µ—Ä–æ–π —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç 1 —Å–ª—É—á–∞–π–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç –∏–∑ —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å). –°–±—Ä–æ—à–µ–Ω–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç –ø–æ–º–µ—â–∞–µ—Ç—Å—è –≤ –∑–æ–Ω—É, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≥–µ—Ä–æ–π, –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–¥–æ–±—Ä–∞–Ω.',
  },
  {
    name: '–î–µ–º–æ–Ω–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫—Ä–µ–ø–ª–µ–Ω–∏–µ',
    icon: 'üî•',
    chance: 0.3,
    generateDescription: (_rng, diff) => {
      const freq = diff === 'nightmare' ? 2 : 3;
      return `–ö–∞–∂–¥—ã–µ ${freq} —Ä–∞—É–Ω–¥–∞ —Ä–∞–∑—ã–≥—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ—è–≤–ª–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ—Ç—Ä—è–¥–∞ –≤ —Å–ª—É—á–∞–π–Ω–æ–π –∑–æ–Ω–µ –ø–æ—è–≤–ª–µ–Ω–∏—è. –õ–∏–¥–µ—Ä —ç—Ç–æ–≥–æ –æ—Ç—Ä—è–¥–∞ –∏–º–µ–µ—Ç +1 –∫ –∑–¥–æ—Ä–æ–≤—å—é.`;
    },
  },
  {
    name: '–ë–ª–∞–≥–æ—Å–ª–æ–≤–µ–Ω–∏–µ –°–≤–µ—Ç–∞',
    icon: '‚úùÔ∏è',
    chance: 0.25,
    generateDescription: () =>
      '–ó–æ–Ω—ã —Å –∂–µ—Ç–æ–Ω–∞–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —Å—á–∏—Ç–∞—é—Ç—Å—è –æ—Å–≤—è—â—ë–Ω–Ω—ã–º–∏. –ì–µ—Ä–æ–π, –Ω–∞—á–∏–Ω–∞—é—â–∏–π —Å–≤–æ–π —Ö–æ–¥ –≤ –æ—Å–≤—è—â—ë–Ω–Ω–æ–π –∑–æ–Ω–µ, –∏—Å—Ü–µ–ª—è–µ—Ç 1 —Ä–∞–Ω–µ–Ω–∏–µ. –í—Ä–∞–≥–∏ –≤ –æ—Å–≤—è—â—ë–Ω–Ω–æ–π –∑–æ–Ω–µ –ø–æ–ª—É—á–∞—é—Ç -1 –∫ –∞—Ç–∞–∫–µ.',
  },
];

// ============================================================
// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è
// ============================================================

function generateName(rng: SeededRandom): { name: string; icon: string } {
  const prefix = rng.pick(NAME_PREFIXES);
  const subject = rng.pick(NAME_SUBJECTS);
  const suffix = rng.pick(NAME_SUFFIXES);
  const icons = ['‚öîÔ∏è', 'üî•', 'üíÄ', 'üåë', 'üëë', 'üêâ', 'üó°Ô∏è', '‚ò†Ô∏è', 'üè∞', 'üåÄ'];
  return {
    name: `${prefix} ${subject} ${suffix}`,
    icon: rng.pick(icons),
  };
}

function generateNarrative(rng: SeededRandom): string {
  const template = rng.pick(NARRATIVE_TEMPLATES);
  const place = rng.pick(NARRATIVE_PLACES);
  const threat = rng.pick(NARRATIVE_THREATS);
  const mission = rng.pick(NARRATIVE_MISSIONS);
  return template
    .replace('{place}', place)
    .replace('{threat}', threat)
    .replace('{mission}', mission)
    .replace(
      '{danger}',
      rng.pick(['–Ω–µ–≤–µ–¥–æ–º–∞—è –æ–ø–∞—Å–Ω–æ—Å—Ç—å', '–¥—Ä–µ–≤–Ω–µ–µ –∑–ª–æ', '–¥–µ–º–æ–Ω–∏—á–µ—Å–∫–∞—è —Å–∫–≤–µ—Ä–Ω–∞']),
    );
}

function getTileCount(mapSize: MapSize, rng: SeededRandom): number {
  switch (mapSize) {
    case 'small':
      return 2;
    case 'medium':
      return 3;
    case 'large':
      return rng.int(4, 5);
  }
}

function generateTiles(rng: SeededRandom, count: number): MapTile[] {
  return rng.pickN(ALL_TILES, count);
}

function generateObjectives(
  rng: SeededRandom,
  difficulty: DifficultyLevel,
): Objective[] {
  // –í—ã–±–∏—Ä–∞–µ–º 1-2 –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–∏–ø–∞ —Ü–µ–ª–µ–π
  const numObjectives = rng.int(1, 2);

  // –í–∑–≤–µ—à–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä
  const weightedTemplates = OBJECTIVE_TEMPLATES.flatMap((t) =>
    Array(t.weight).fill(t),
  );

  const selected: ObjectiveTemplate[] = [];
  let attempts = 0;

  while (selected.length < numObjectives && attempts < 50) {
    const candidate = rng.pick(weightedTemplates);
    const isCompatible = selected.every(
      (s) =>
        !s.incompatible?.includes(candidate.type) &&
        !candidate.incompatible?.includes(s.type) &&
        s.type !== candidate.type,
    );
    if (isCompatible) {
      selected.push(candidate);
    }
    attempts++;
  }

  return selected.map((template, idx) => ({
    type: template.type,
    order: idx + 1,
    title: template.generateTitle(rng),
    description: template.generateDescription(rng, difficulty),
    icon: template.icon,
  }));
}

function generateSpecialRules(
  rng: SeededRandom,
  difficulty: DifficultyLevel,
): SpecialRule[] {
  const rules: SpecialRule[] = [];
  const difficultyBonus =
    difficulty === 'easy'
      ? -0.1
      : difficulty === 'normal'
        ? 0
        : difficulty === 'hard'
          ? 0.1
          : 0.2;

  for (const template of rng.shuffle([...SPECIAL_RULE_TEMPLATES])) {
    if (rules.length >= 3) break;
    if (rng.random() < template.chance + difficultyBonus) {
      rules.push({
        name: template.name,
        icon: template.icon,
        description: template.generateDescription(rng, difficulty),
      });
    }
  }

  // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —Ö–æ—Ç—è –±—ã 1 –ø—Ä–∞–≤–∏–ª–æ
  if (rules.length === 0) {
    const fallback = rng.pick(SPECIAL_RULE_TEMPLATES);
    rules.push({
      name: fallback.name,
      icon: fallback.icon,
      description: fallback.generateDescription(rng, difficulty),
    });
  }

  return rules;
}

function generateTokens(
  rng: SeededRandom,
  tileCount: number,
  difficulty: DifficultyLevel,
  playerCount: number,
  objectives: Objective[],
): TokenPlacement[] {
  const diffMult =
    difficulty === 'easy'
      ? 0.7
      : difficulty === 'normal'
        ? 1.0
        : difficulty === 'hard'
          ? 1.3
          : 1.5;

  const lootMult =
    difficulty === 'easy'
      ? 1.3
      : difficulty === 'hard'
        ? 0.7
        : difficulty === 'nightmare'
          ? 0.5
          : 1.0;

  const baseSpawns = Math.max(2, Math.round(tileCount * 1.5 * diffMult));
  const baseDoors = Math.max(2, tileCount * 2 + rng.int(-1, 2));

  // –ü–æ–¥—Å—á—ë—Ç –∂–µ—Ç–æ–Ω–æ–≤ —Ü–µ–ª–µ–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–¥–∞—á
  let objectiveTokens = 0;
  for (const obj of objectives) {
    switch (obj.type) {
      case 'COLLECT_ITEMS':
      case 'FORGE_ARTIFACT':
      case 'TIMED_COLLECTION':
        objectiveTokens +=
          difficulty === 'easy' ? 2 : difficulty === 'normal' ? 3 : 4;
        break;
      case 'ACTIVATE_SWITCHES':
        objectiveTokens +=
          difficulty === 'hard' || difficulty === 'nightmare' ? 3 : 2;
        break;
      case 'DESTROY_TARGETS':
        objectiveTokens +=
          difficulty === 'easy' ? 3 : difficulty === 'normal' ? 4 : 5;
        break;
      case 'HUNT_MONSTERS':
        objectiveTokens +=
          difficulty === 'easy' ? 2 : difficulty === 'normal' ? 3 : 4;
        break;
      case 'COLLECT_SOULS':
        objectiveTokens += rng.int(3, 4);
        break;
      case 'RITUAL_SEQUENCE':
        objectiveTokens += difficulty === 'easy' ? 3 : 4;
        break;
      case 'PURIFY_CORRUPTION':
        objectiveTokens +=
          difficulty === 'easy' ? 3 : difficulty === 'normal' ? 4 : 5;
        break;
      default:
        objectiveTokens += 1;
    }
  }

  const tokens: TokenPlacement[] = [
    {
      name: '–°—Ç–∞—Ä—Ç–æ–≤–∞—è –∑–æ–Ω–∞ –≥–µ—Ä–æ–µ–≤',
      icon: 'üè†',
      count: 1,
    },
    {
      name: '–ñ–µ—Ç–æ–Ω –ø–æ—è–≤–ª–µ–Ω–∏—è –≤—Ä–∞–≥–æ–≤',
      icon: '‚öîÔ∏è',
      count: baseSpawns,
    },
    {
      name: '–°—Ç–∞—Ä—Ç–æ–≤–∞—è –∑–æ–Ω–∞ –æ—Ç—Ä—è–¥–∞',
      icon: 'üó°Ô∏è',
      count: Math.max(1, Math.round(tileCount * 0.6 * diffMult)),
    },
    {
      name: '–ñ–µ—Ç–æ–Ω –∑–∞–∫—Ä—ã—Ç–æ–π –¥–≤–µ—Ä–∏',
      icon: 'üö™',
      count: baseDoors,
    },
    {
      name: '–ñ–µ—Ç–æ–Ω –ø–æ—Ä—Ç–∞–ª–∞ –±—Ä–æ–¥—è—á–µ–≥–æ –º–æ–Ω—Å—Ç—Ä–∞',
      icon: 'üêâ',
      count: 1,
    },
    {
      name: '–ñ–µ—Ç–æ–Ω –ø–æ—Ä—Ç–∞–ª–∞',
      icon: 'üåÄ',
      count: Math.min(playerCount <= 2 ? 2 : 3, tileCount),
    },
    {
      name: '–ñ–µ—Ç–æ–Ω –¥–æ–±—ã—á–∏',
      icon: 'üí∞',
      count:
        playerCount <= 2
          ? Math.round(2 * lootMult)
          : playerCount <= 4
            ? Math.round(3 * lootMult)
            : Math.round(4 * lootMult),
    },
    {
      name: '–ñ–µ—Ç–æ–Ω –æ–±—ã—á–Ω–æ–≥–æ —Å—É–Ω–¥—É–∫–∞',
      icon: 'üì¶',
      count: Math.max(1, Math.round(tileCount * 0.5 * lootMult)),
    },
    {
      name: '–ñ–µ—Ç–æ–Ω –±–æ–ª—å—à–æ–≥–æ —Å—É–Ω–¥—É–∫–∞',
      icon: 'üéÅ',
      count: Math.max(1, Math.round(tileCount * 0.3 * lootMult)),
    },
    {
      name: '–ñ–µ—Ç–æ–Ω –∫—É–∑–Ω–∏',
      icon: 'üî®',
      count: Math.max(1, Math.round(tileCount * 0.3)),
    },
    {
      name: '–ñ–µ—Ç–æ–Ω –∏—Å—Ç–æ—á–Ω–∏–∫–∞',
      icon: 'üíß',
      count: Math.max(1, Math.round(tileCount * 0.4)),
    },
    {
      name: '–ú–æ—Å—Ç',
      icon: 'üåâ',
      count: rng.int(0, Math.min(2, tileCount - 1)),
    },
  ];

  // –õ–æ–≤—É—à–∫–∏ (–±–æ–ª—å—à–µ –Ω–∞ –≤—ã—Å–æ–∫–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏)
  const trapCount = Math.round(tileCount * 0.4 * diffMult);
  if (trapCount > 0) {
    if (rng.random() > 0.5) {
      tokens.push({
        name: '–ñ–µ—Ç–æ–Ω –ª–æ–≤—É—à–∫–∏ —Å –∫–æ–ª—å—è–º–∏',
        icon: 'üî±',
        count: Math.ceil(trapCount / 2),
      });
      tokens.push({
        name: '–ñ–µ—Ç–æ–Ω –∫–∞–ø–∫–∞–Ω–∞',
        icon: 'ü™§',
        count: Math.floor(trapCount / 2) || 1,
      });
    } else {
      tokens.push({
        name: '–ñ–µ—Ç–æ–Ω –ª–æ–≤—É—à–∫–∏ —Å –∫–æ–ª—å—è–º–∏',
        icon: 'üî±',
        count: trapCount,
      });
    }
  }

  // –ñ–µ—Ç–æ–Ω—ã —Ü–µ–ª–µ–π
  if (objectiveTokens > 0) {
    tokens.push({
      name: '–¶–≤–µ—Ç–Ω–æ–π –∂–µ—Ç–æ–Ω —Ü–µ–ª–∏',
      icon: 'üéØ',
      count: Math.max(1, objectiveTokens),
    });
  }

  // –°–µ—Ä—ã–π –∂–µ—Ç–æ–Ω —Ü–µ–ª–∏ (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞)
  const needsGrayTarget = objectives.some((o) =>
    [
      'CLOSE_RIFT',
      'ESCORT_NPC',
      'FORGE_ARTIFACT',
      'COLLECT_SOULS',
      'DEFEND_ZONE',
      'RACE_TO_EXIT',
      'DEFEAT_BOSS',
    ].includes(o.type),
  );
  if (needsGrayTarget) {
    tokens.push({
      name: '–°–µ—Ä—ã–π –∂–µ—Ç–æ–Ω —Ü–µ–ª–∏',
      icon: '‚¨ú',
      count: 1,
    });
  }

  // –ñ–µ—Ç–æ–Ω—ã –ø–æ—Ä—á–∏ –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–µ—Ö–∞–Ω–∏–∫
  const needsCorruption = objectives.some((o) =>
    ['HUNT_MONSTERS', 'PURIFY_CORRUPTION'].includes(o.type),
  );
  if (needsCorruption) {
    tokens.push({
      name: '–ñ–µ—Ç–æ–Ω –ø–æ—Ä—á–∏',
      icon: '‚ò†Ô∏è',
      count: objectives.find((o) => o.type === 'PURIFY_CORRUPTION')
        ? difficulty === 'easy'
          ? 3
          : difficulty === 'normal'
            ? 4
            : 5
        : rng.int(3, 4),
    });
  }

  // –ñ–µ—Ç–æ–Ω—ã –∫–æ–ª–æ–Ω–Ω
  if (rng.random() > 0.5 && tileCount >= 3) {
    tokens.push({
      name: '–ñ–µ—Ç–æ–Ω –∫–æ–ª–æ–Ω–Ω—ã',
      icon: 'üèõÔ∏è',
      count: rng.int(1, 2),
    });
  }

  return tokens.filter((t) => t.count > 0);
}

function generateConditions(
  objectives: Objective[],
  difficulty: DifficultyLevel,
  rng: SeededRandom,
): WinLoseConditions {
  const victoryParts = objectives.map((o) => o.title.toLowerCase());
  const victory = `–í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –∑–∞–¥–∞—á–∏ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è: ${victoryParts.join('; ')}.`;

  const defeatOptions = ['–ï—Å–ª–∏ –Ω–µ—Ç –∂–µ—Ç–æ–Ω–æ–≤ –∏—Å–∫—Ä—ã –∂–∏–∑–Ω–∏ –ø—Ä–∏ –æ–≥–ª—É—à–µ–Ω–∏–∏ –≥–µ—Ä–æ—è.'];

  // –î–æ–±–∞–≤–ª—è–µ–º —É—Å–ª–æ–≤–∏—è –ø–æ—Ä–∞–∂–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –º–µ—Ö–∞–Ω–∏–∫
  for (const obj of objectives) {
    if (obj.type === 'ESCORT_NPC') {
      defeatOptions.push('–ì–∏–±–µ–ª—å —Å–æ—é–∑–Ω–∏–∫–∞ (NPC).');
    }
    if (obj.type === 'TIMED_COLLECTION') {
      defeatOptions.push('–ò—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –¥—É—Ö-–∫–ª—é—á–∞.');
    }
    if (obj.type === 'RACE_TO_EXIT') {
      defeatOptions.push('–ò—Å—Ç–µ—á–µ–Ω–∏–µ –æ—Ç–≤–µ–¥—ë–Ω–Ω—ã—Ö —Ä–∞—É–Ω–¥–æ–≤.');
    }
    if (obj.type === 'DEFEND_ZONE') {
      defeatOptions.push(
        '–í—Å–µ –≥–µ—Ä–æ–∏ –ø–æ–∫–∏–Ω—É–ª–∏ –∑–æ–Ω—É –∞–ª—Ç–∞—Ä—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–∞ 3+ —Ä–∞—É–Ω–¥–∞.',
      );
    }
  }

  if (difficulty === 'nightmare') {
    defeatOptions.push(
      rng.pick([
        '–ï—Å–ª–∏ —à–∫–∞–ª–∞ —Ç—å–º—ã –¥–æ—Å—Ç–∏–≥–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π —è—á–µ–π–∫–∏.',
        '–ï—Å–ª–∏ 3 –∏–ª–∏ –±–æ–ª–µ–µ –≥–µ—Ä–æ—è –æ–≥–ª—É—à–µ–Ω—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.',
        '–ï—Å–ª–∏ –Ω–∞ –ø–æ–ª–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–∞—Ö–æ–¥—è—Ç—Å—è 4+ –±—Ä–æ–¥—è—á–∏—Ö –º–æ–Ω—Å—Ç—Ä–∞.',
      ]),
    );
  }

  return {
    victory,
    defeat: defeatOptions.join(' '),
  };
}

function generateDifficultyModifiers(difficulty: DifficultyLevel): string[] {
  switch (difficulty) {
    case 'easy':
      return [
        '–ñ–µ—Ç–æ–Ω—ã –¥–æ–±—ã—á–∏: +1 –∫ –±–∞–∑–æ–≤–æ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É',
        '–í—Ä–∞–≥–∏: –∑–¥–æ—Ä–æ–≤—å–µ -1 (–º–∏–Ω. 1)',
        '–®–∫–∞–ª–∞ —Ç—å–º—ã: –ø—Ä–æ–¥–≤–∏–≥–∞–µ—Ç—Å—è –Ω–∞ 1 —è—á–µ–π–∫—É –∫–∞–∂–¥—ã–µ 2 —Ñ–∞–∑—ã —Ç—å–º—ã',
        '–ë—Ä–æ–¥—è—á–∏–µ –º–æ–Ω—Å—Ç—Ä—ã –ø–æ—è–≤–ª—è—é—Ç—Å—è —Å -1 –∫ –∑–¥–æ—Ä–æ–≤—å—é',
      ];
    case 'normal':
      return ['–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤'];
    case 'hard':
      return [
        '–ñ–µ—Ç–æ–Ω—ã –¥–æ–±—ã—á–∏: -1 –∫ –±–∞–∑–æ–≤–æ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É',
        '–¢–æ—á–∫–∏ –ø–æ—è–≤–ª–µ–Ω–∏—è –≤—Ä–∞–≥–æ–≤: +1 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è',
        '–ö–∞–∂–¥—ã–π –æ—Ç—Ä—è–¥ –∏–º–µ–µ—Ç +1 –ø—Ä–∏—Å–ø–µ—à–Ω–∏–∫–∞',
        '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ª–æ–≤—É—à–∫–∞ –≤ –∫–∞–∂–¥–æ–º –∑–∞–ª–µ',
      ];
    case 'nightmare':
      return [
        '–ñ–µ—Ç–æ–Ω—ã –¥–æ–±—ã—á–∏: -2 –∫ –±–∞–∑–æ–≤–æ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É',
        '–¢–æ—á–∫–∏ –ø–æ—è–≤–ª–µ–Ω–∏—è –≤—Ä–∞–≥–æ–≤: +2 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö',
        '–ö–∞–∂–¥—ã–π –æ—Ç—Ä—è–¥ –∏–º–µ–µ—Ç +2 –ø—Ä–∏—Å–ø–µ—à–Ω–∏–∫–∞',
        '–õ–∏–¥–µ—Ä—ã –æ—Ç—Ä—è–¥–æ–≤ –∏–º–µ—é—Ç +2 –∫ –∑–¥–æ—Ä–æ–≤—å—é',
        '–ë—Ä–æ–¥—è—á–∏–µ –º–æ–Ω—Å—Ç—Ä—ã –ø–æ–ª—É—á–∞—é—Ç +1 –∫—É–±–∏–∫ –∞—Ç–∞–∫–∏',
        '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ –ø–æ—Ä–∞–∂–µ–Ω–∏—è (—Å–º. –Ω–∏–∂–µ)',
      ];
  }
}

// ============================================================
// –†–∞—Å–∫–ª–∞–¥–∫–∞ —Ç–∞–π–ª–æ–≤ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∂–µ—Ç–æ–Ω–æ–≤
// ============================================================

/** –®–∞–±–ª–æ–Ω—ã —Ä–∞—Å–∫–ª–∞–¥–æ–∫: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–∑–∏—Ü–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–∞–π–ª–æ–≤ */
const LAYOUT_PATTERNS: Record<number, { type: LayoutType; positions: GridPosition[] }[]> = {
  2: [
    { type: 'linear', positions: [{ row: 0, col: 0 }, { row: 0, col: 1 }] },
    { type: 'linear', positions: [{ row: 0, col: 0 }, { row: 1, col: 0 }] },
  ],
  3: [
    { type: 'linear', positions: [{ row: 0, col: 0 }, { row: 0, col: 1 }, { row: 0, col: 2 }] },
    { type: 'L-shape', positions: [{ row: 0, col: 0 }, { row: 0, col: 1 }, { row: 1, col: 1 }] },
    { type: 'L-shape', positions: [{ row: 0, col: 0 }, { row: 1, col: 0 }, { row: 1, col: 1 }] },
    { type: 'linear', positions: [{ row: 0, col: 0 }, { row: 1, col: 0 }, { row: 2, col: 0 }] },
  ],
  4: [
    { type: 'linear', positions: [{ row: 0, col: 0 }, { row: 0, col: 1 }, { row: 0, col: 2 }, { row: 0, col: 3 }] },
    { type: 'L-shape', positions: [{ row: 0, col: 0 }, { row: 0, col: 1 }, { row: 0, col: 2 }, { row: 1, col: 2 }] },
    { type: 'T-shape', positions: [{ row: 0, col: 0 }, { row: 0, col: 1 }, { row: 0, col: 2 }, { row: 1, col: 1 }] },
    { type: 'zigzag', positions: [{ row: 0, col: 0 }, { row: 0, col: 1 }, { row: 1, col: 1 }, { row: 1, col: 2 }] },
    { type: 'L-shape', positions: [{ row: 0, col: 0 }, { row: 1, col: 0 }, { row: 2, col: 0 }, { row: 2, col: 1 }] },
  ],
  5: [
    { type: 'cross', positions: [{ row: 0, col: 1 }, { row: 1, col: 0 }, { row: 1, col: 1 }, { row: 1, col: 2 }, { row: 2, col: 1 }] },
    { type: 'L-shape', positions: [{ row: 0, col: 0 }, { row: 0, col: 1 }, { row: 0, col: 2 }, { row: 0, col: 3 }, { row: 1, col: 3 }] },
    { type: 'T-shape', positions: [{ row: 0, col: 0 }, { row: 0, col: 1 }, { row: 0, col: 2 }, { row: 1, col: 1 }, { row: 2, col: 1 }] },
    { type: 'zigzag', positions: [{ row: 0, col: 0 }, { row: 0, col: 1 }, { row: 1, col: 1 }, { row: 1, col: 2 }, { row: 2, col: 2 }] },
    { type: 'linear', positions: [{ row: 0, col: 0 }, { row: 0, col: 1 }, { row: 0, col: 2 }, { row: 0, col: 3 }, { row: 0, col: 4 }] },
  ],
};

/** –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è—é—Ç—Å—è –ª–∏ –¥–≤–µ –ø–æ–∑–∏—Ü–∏–∏ —Å–æ—Å–µ–¥–Ω–∏–º–∏ (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ –∏–ª–∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ) */
function areAdjacent(a: GridPosition, b: GridPosition): boolean {
  return (
    (Math.abs(a.row - b.row) === 1 && a.col === b.col) ||
    (Math.abs(a.col - b.col) === 1 && a.row === b.row)
  );
}

/** –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–æ–ª–∏ —Ç–∞–π–ª–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–¥–∞—á */
function assignTileRoles(
  tileCount: number,
  objectives: Objective[],
  rng: SeededRandom,
): TileRole[] {
  const roles: TileRole[] = new Array(tileCount).fill('middle');
  roles[0] = 'start';

  const hasBoss = objectives.some((o) => o.type === 'DEFEAT_BOSS');
  const hasExit = objectives.some((o) =>
    ['RACE_TO_EXIT', 'COLLECT_SOULS', 'CLOSE_RIFT', 'ESCORT_NPC'].includes(o.type),
  );

  if (hasBoss && tileCount >= 3) {
    roles[tileCount - 1] = 'boss';
  } else if (hasExit && tileCount >= 2) {
    roles[tileCount - 1] = 'exit';
  }

  // –ù–∞–∑–Ω–∞—á–∞–µ–º objective —Ç–∞–π–ª—ã –¥–ª—è —Å—Ä–µ–¥–Ω–∏—Ö
  const middleIndices = roles
    .map((r, i) => (r === 'middle' ? i : -1))
    .filter((i) => i >= 0);

  if (middleIndices.length > 0) {
    const objIdx = rng.pick(middleIndices);
    roles[objIdx] = 'objective';
  }

  return roles;
}

/** –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –¥–≤–µ—Ä–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–¥–∞—á –∏ –ø–æ–∑–∏—Ü–∏–∏ */
function chooseDoorType(
  fromRole: TileRole,
  toRole: TileRole,
  objectives: Objective[],
  rng: SeededRandom,
): DoorType {
  // –î–≤–µ—Ä—å –≤ –∑–∞–ª –±–æ—Å—Å–∞ ‚Äî –∑–∞–ø–µ—Ä—Ç—ã–µ –≤—Ä–∞—Ç–∞
  if (toRole === 'boss') return 'gate';
  // –ò–Ω–æ–≥–¥–∞ –∑–∞–ø–µ—Ä—Ç—ã–µ –¥–≤–µ—Ä–∏ –¥–ª—è –∏–Ω—Ç–µ—Ä–µ—Å–∞
  if (
    objectives.some((o) => o.type === 'ACTIVATE_SWITCHES') &&
    toRole === 'exit'
  ) {
    return 'gate';
  }
  if (fromRole !== 'start' && rng.random() < 0.2) return 'locked';
  return 'normal';
}

/** –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –º–µ–∂–¥—É —Å–æ—Å–µ–¥–Ω–∏–º–∏ —Ç–∞–π–ª–∞–º–∏ */
function generateConnections(
  placedTiles: PlacedTile[],
  objectives: Objective[],
  rng: SeededRandom,
): TileConnection[] {
  const connections: TileConnection[] = [];
  for (let i = 0; i < placedTiles.length; i++) {
    for (let j = i + 1; j < placedTiles.length; j++) {
      if (areAdjacent(placedTiles[i].position, placedTiles[j].position)) {
        connections.push({
          fromTileId: placedTiles[i].id,
          toTileId: placedTiles[j].id,
          doorType: chooseDoorType(
            placedTiles[i].role,
            placedTiles[j].role,
            objectives,
            rng,
          ),
        });
      }
    }
  }
  return connections;
}

/** –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∂–µ—Ç–æ–Ω—ã –ø–æ —Ç–∞–π–ª–∞–º –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Ö —Ä–æ–ª–µ–π –∏ –∑–∞–¥–∞—á */
function distributeTokensToTiles(
  placedTiles: PlacedTile[],
  tokens: TokenPlacement[],
  _objectives: Objective[],
  _difficulty: DifficultyLevel,
  rng: SeededRandom,
): void {
  const tileCount = placedTiles.length;

  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: —Ä–∞–∑–ª–æ–∂–∏—Ç—å count –∂–µ—Ç–æ–Ω–æ–≤ –ø–æ —Ç–∞–π–ª–∞–º
  const spread = (
    icon: string,
    name: string,
    total: number,
    eligible: PlacedTile[],
  ) => {
    if (total <= 0 || eligible.length === 0) return;
    // –°–Ω–∞—á–∞–ª–∞ –ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ –∫–∞–∂–¥—ã–π, –ø–æ—Ç–æ–º –æ—Å—Ç–∞—Ç–∫–∏
    const shuffled = rng.shuffle([...eligible]);
    for (let i = 0; i < total; i++) {
      const tile = shuffled[i % shuffled.length];
      const existing = tile.tokens.find((t) => t.name === name);
      if (existing) {
        existing.count++;
      } else {
        tile.tokens.push({ name, icon, count: 1 });
      }
    }
  };

  // 1. –°—Ç–∞—Ä—Ç–æ–≤–∞—è –∑–æ–Ω–∞ –≥–µ—Ä–æ–µ–≤ ‚Äî —Ç–æ–ª—å–∫–æ –Ω–∞ start-—Ç–∞–π–ª–µ
  const startTile = placedTiles.find((t) => t.role === 'start');
  if (startTile) {
    startTile.tokens.push({ name: '–°—Ç–∞—Ä—Ç–æ–≤–∞—è –∑–æ–Ω–∞ –≥–µ—Ä–æ–µ–≤', icon: 'üè†', count: 1 });
  }

  // 2. –°–µ—Ä—ã–π –∂–µ—Ç–æ–Ω —Ü–µ–ª–∏ ‚Äî –Ω–∞ boss/exit —Ç–∞–π–ª–µ
  const grayTargetToken = tokens.find((t) => t.name === '–°–µ—Ä—ã–π –∂–µ—Ç–æ–Ω —Ü–µ–ª–∏');
  if (grayTargetToken) {
    const targetTile = placedTiles.find(
      (t) => t.role === 'boss' || t.role === 'exit',
    ) ?? placedTiles[placedTiles.length - 1];
    targetTile.tokens.push({ name: '–°–µ—Ä—ã–π –∂–µ—Ç–æ–Ω —Ü–µ–ª–∏', icon: '‚¨ú', count: 1 });
  }

  // 3. –¶–≤–µ—Ç–Ω—ã–µ –∂–µ—Ç–æ–Ω—ã —Ü–µ–ª–µ–π ‚Äî —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ objective –∏ middle —Ç–∞–π–ª–∞–º (–Ω–µ start)
  const objToken = tokens.find((t) => t.name === '–¶–≤–µ—Ç–Ω–æ–π –∂–µ—Ç–æ–Ω —Ü–µ–ª–∏');
  if (objToken && objToken.count > 0) {
    const eligible = placedTiles.filter((t) => t.role !== 'start');
    spread('üéØ', '–¶–≤–µ—Ç–Ω–æ–π –∂–µ—Ç–æ–Ω —Ü–µ–ª–∏', objToken.count, eligible.length > 0 ? eligible : placedTiles);
  }

  // 4. –ñ–µ—Ç–æ–Ω—ã –ø–æ—Ä—á–∏ ‚Äî –Ω–∞ objective –∏ middle —Ç–∞–π–ª—ã
  const corruptionToken = tokens.find((t) => t.name === '–ñ–µ—Ç–æ–Ω –ø–æ—Ä—á–∏');
  if (corruptionToken && corruptionToken.count > 0) {
    const eligible = placedTiles.filter(
      (t) => t.role === 'objective' || t.role === 'middle',
    );
    spread(
      '‚ò†Ô∏è',
      '–ñ–µ—Ç–æ–Ω –ø–æ—Ä—á–∏',
      corruptionToken.count,
      eligible.length > 0 ? eligible : placedTiles,
    );
  }

  // 5. –ñ–µ—Ç–æ–Ω—ã –ø–æ—è–≤–ª–µ–Ω–∏—è –≤—Ä–∞–≥–æ–≤ ‚Äî —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ –≤—Å–µ–º –∫—Ä–æ–º–µ start (–ø—Ä–∏ –º–∞–ª–æ–º –∫–æ–ª-–≤–µ ‚Äî –∏ –Ω–∞ start)
  const spawnToken = tokens.find((t) => t.name === '–ñ–µ—Ç–æ–Ω –ø–æ—è–≤–ª–µ–Ω–∏—è –≤—Ä–∞–≥–æ–≤');
  if (spawnToken && spawnToken.count > 0) {
    const eligible = tileCount <= 2 ? placedTiles : placedTiles.filter((t) => t.role !== 'start');
    spread('‚öîÔ∏è', '–ñ–µ—Ç–æ–Ω –ø–æ—è–≤–ª–µ–Ω–∏—è –≤—Ä–∞–≥–æ–≤', spawnToken.count, eligible);
  }

  // 6. –°—Ç–∞—Ä—Ç–æ–≤–∞—è –∑–æ–Ω–∞ –æ—Ç—Ä—è–¥–∞ ‚Äî –Ω–∞ middle/objective —Ç–∞–π–ª—ã
  const squadToken = tokens.find((t) => t.name === '–°—Ç–∞—Ä—Ç–æ–≤–∞—è –∑–æ–Ω–∞ –æ—Ç—Ä—è–¥–∞');
  if (squadToken && squadToken.count > 0) {
    const eligible = placedTiles.filter(
      (t) => t.role !== 'start' && t.role !== 'boss',
    );
    spread('üó°Ô∏è', '–°—Ç–∞—Ä—Ç–æ–≤–∞—è –∑–æ–Ω–∞ –æ—Ç—Ä—è–¥–∞', squadToken.count, eligible.length > 0 ? eligible : placedTiles);
  }

  // 7. –ü–æ—Ä—Ç–∞–ª –±—Ä–æ–¥—è—á–µ–≥–æ –º–æ–Ω—Å—Ç—Ä–∞ ‚Äî –Ω–∞ objective –∏–ª–∏ middle
  const roamingPortal = tokens.find(
    (t) => t.name === '–ñ–µ—Ç–æ–Ω –ø–æ—Ä—Ç–∞–ª–∞ –±—Ä–æ–¥—è—á–µ–≥–æ –º–æ–Ω—Å—Ç—Ä–∞',
  );
  if (roamingPortal) {
    const eligible = placedTiles.filter(
      (t) => t.role === 'objective' || t.role === 'middle',
    );
    const tile = eligible.length > 0 ? rng.pick(eligible) : placedTiles[Math.min(1, tileCount - 1)];
    tile.tokens.push({ name: '–ü–æ—Ä—Ç–∞–ª –±—Ä–æ–¥—è—á–µ–≥–æ –º–æ–Ω—Å—Ç—Ä–∞', icon: 'üêâ', count: 1 });
  }

  // 8. –ñ–µ—Ç–æ–Ω—ã –ø–æ—Ä—Ç–∞–ª–æ–≤ ‚Äî —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ –¥–∞–ª—å–Ω–∏–º —Ç–∞–π–ª–∞–º
  const portalToken = tokens.find((t) => t.name === '–ñ–µ—Ç–æ–Ω –ø–æ—Ä—Ç–∞–ª–∞');
  if (portalToken && portalToken.count > 0) {
    const eligible = placedTiles.filter((t) => t.role !== 'start');
    spread('üåÄ', '–ñ–µ—Ç–æ–Ω –ø–æ—Ä—Ç–∞–ª–∞', portalToken.count, eligible.length > 0 ? eligible : placedTiles);
  }

  // 9. –°—É–Ω–¥—É–∫–∏ ‚Äî –Ω–∞ middle/objective —Ç–∞–π–ª—ã
  const chestToken = tokens.find((t) => t.name === '–ñ–µ—Ç–æ–Ω –æ–±—ã—á–Ω–æ–≥–æ —Å—É–Ω–¥—É–∫–∞');
  if (chestToken && chestToken.count > 0) {
    const eligible = placedTiles.filter((t) => t.role !== 'boss');
    spread('üì¶', '–û–±—ã—á–Ω—ã–π —Å—É–Ω–¥—É–∫', chestToken.count, eligible.length > 0 ? eligible : placedTiles);
  }

  const bigChestToken = tokens.find((t) => t.name === '–ñ–µ—Ç–æ–Ω –±–æ–ª—å—à–æ–≥–æ —Å—É–Ω–¥—É–∫–∞');
  if (bigChestToken && bigChestToken.count > 0) {
    const eligible = placedTiles.filter(
      (t) => t.role === 'objective' || t.role === 'middle',
    );
    spread('üéÅ', '–ë–æ–ª—å—à–æ–π —Å—É–Ω–¥—É–∫', bigChestToken.count, eligible.length > 0 ? eligible : placedTiles);
  }

  // 10. –ö—É–∑–Ω—è –∏ –∏—Å—Ç–æ—á–Ω–∏–∫ ‚Äî –ø–æ 1 –Ω–∞ —Ä–∞–∑–Ω—ã–µ —Ç–∞–π–ª—ã
  const forgeToken = tokens.find((t) => t.name === '–ñ–µ—Ç–æ–Ω –∫—É–∑–Ω–∏');
  if (forgeToken && forgeToken.count > 0) {
    const eligible = placedTiles.filter((t) => t.role !== 'boss');
    spread('üî®', '–ö—É–∑–Ω—è', forgeToken.count, eligible.length > 0 ? eligible : placedTiles);
  }

  const sourceToken = tokens.find((t) => t.name === '–ñ–µ—Ç–æ–Ω –∏—Å—Ç–æ—á–Ω–∏–∫–∞');
  if (sourceToken && sourceToken.count > 0) {
    const eligible = placedTiles.filter((t) => t.role !== 'boss');
    spread('üíß', '–ò—Å—Ç–æ—á–Ω–∏–∫', sourceToken.count, eligible.length > 0 ? eligible : placedTiles);
  }

  // 11. –ú–æ—Å—Ç—ã ‚Äî –Ω–∞ —Ç–∞–π–ª—ã —Å –º–æ—Å—Ç–∞–º–∏
  const bridgeToken = tokens.find((t) => t.name === '–ú–æ—Å—Ç');
  if (bridgeToken && bridgeToken.count > 0) {
    spread('üåâ', '–ú–æ—Å—Ç', bridgeToken.count, placedTiles);
  }

  // 12. –õ–æ–≤—É—à–∫–∏ ‚Äî –Ω–∞ —Å—Ä–µ–¥–Ω–∏–µ/–¥–∞–ª—å–Ω–∏–µ —Ç–∞–π–ª—ã
  const spikeToken = tokens.find((t) => t.name === '–ñ–µ—Ç–æ–Ω –ª–æ–≤—É—à–∫–∏ —Å –∫–æ–ª—å—è–º–∏');
  if (spikeToken && spikeToken.count > 0) {
    const eligible = placedTiles.filter((t) => t.role !== 'start');
    spread('üî±', '–õ–æ–≤—É—à–∫–∞ —Å –∫–æ–ª—å—è–º–∏', spikeToken.count, eligible.length > 0 ? eligible : placedTiles);
  }

  const trapToken = tokens.find((t) => t.name === '–ñ–µ—Ç–æ–Ω –∫–∞–ø–∫–∞–Ω–∞');
  if (trapToken && trapToken.count > 0) {
    const eligible = placedTiles.filter((t) => t.role !== 'start');
    spread('ü™§', '–ö–∞–ø–∫–∞–Ω', trapToken.count, eligible.length > 0 ? eligible : placedTiles);
  }

  // 13. –ñ–µ—Ç–æ–Ω—ã –¥–æ–±—ã—á–∏ ‚Äî –ø–æ –≤—Å–µ–º —Ç–∞–π–ª–∞–º –∫—Ä–æ–º–µ boss
  const lootToken = tokens.find((t) => t.name === '–ñ–µ—Ç–æ–Ω –¥–æ–±—ã—á–∏');
  if (lootToken && lootToken.count > 0) {
    const eligible = placedTiles.filter((t) => t.role !== 'boss');
    spread('üí∞', '–ñ–µ—Ç–æ–Ω –¥–æ–±—ã—á–∏', lootToken.count, eligible.length > 0 ? eligible : placedTiles);
  }

  // 14. –ö–æ–ª–æ–Ω–Ω—ã
  const columnToken = tokens.find((t) => t.name === '–ñ–µ—Ç–æ–Ω –∫–æ–ª–æ–Ω–Ω—ã');
  if (columnToken && columnToken.count > 0) {
    spread('üèõÔ∏è', '–ö–æ–ª–æ–Ω–Ω–∞', columnToken.count, placedTiles);
  }

  // 15. –î–≤–µ—Ä–∏ ‚Äî –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º (—É–∂–µ –æ—Ç—Ä–∞–∂–µ–Ω—ã –≤ connections)
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –¥–≤–µ—Ä–∏ –Ω–∞ —Ç–∞–π–ª—ã
  const doorToken = tokens.find((t) => t.name === '–ñ–µ—Ç–æ–Ω –∑–∞–∫—Ä—ã—Ç–æ–π –¥–≤–µ—Ä–∏');
  if (doorToken && doorToken.count > 0) {
    const _connDoors = placedTiles.length - 1; // –º–µ–∂–¥—É —Ç–∞–π–ª–∞–º–∏
    const innerDoors = Math.max(0, doorToken.count - _connDoors);
    if (innerDoors > 0) {
      spread('üö™', '–ó–∞–∫—Ä—ã—Ç–∞—è –¥–≤–µ—Ä—å (–≤–Ω—É—Ç—Ä.)', innerDoors, placedTiles);
    }
  }
}

/** –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—É—é —Ä–∞—Å–∫–ª–∞–¥–∫—É –∫–∞—Ä—Ç—ã */
function generateMapLayout(
  tiles: MapTile[],
  tokens: TokenPlacement[],
  objectives: Objective[],
  difficulty: DifficultyLevel,
  rng: SeededRandom,
): MapLayout {
  const tileCount = tiles.length;
  const patterns = LAYOUT_PATTERNS[tileCount] ?? LAYOUT_PATTERNS[3];
  const pattern = rng.pick(patterns);

  // –ù–∞–∑–Ω–∞—á–∞–µ–º —Ä–æ–ª–∏
  const roles = assignTileRoles(tileCount, objectives, rng);

  // –°–æ–∑–¥–∞—ë–º PlacedTile[]
  const placedTiles: PlacedTile[] = tiles.map((tile, i) => ({
    ...tile,
    position: pattern.positions[i],
    role: roles[i],
    tokens: [],
  }));

  // –°–æ–µ–¥–∏–Ω–µ–Ω–∏—è
  const connections = generateConnections(placedTiles, objectives, rng);

  // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –∂–µ—Ç–æ–Ω—ã
  distributeTokensToTiles(placedTiles, tokens, objectives, difficulty, rng);

  // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä —Å–µ—Ç–∫–∏
  const maxRow = Math.max(...placedTiles.map((t) => t.position.row));
  const maxCol = Math.max(...placedTiles.map((t) => t.position.col));

  return {
    placedTiles,
    connections,
    gridSize: { rows: maxRow + 1, cols: maxCol + 1 },
    layoutType: pattern.type,
  };
}

// ============================================================
// –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
// ============================================================

export function generateScenario(config: ScenarioConfig): GeneratedScenario {
  const rng = new SeededRandom(config.seed);

  const { name, icon } = generateName(rng);
  const narrative = generateNarrative(rng);
  const tileCount = getTileCount(config.mapSize, rng);
  const tiles = generateTiles(rng, tileCount);
  const objectives = generateObjectives(rng, config.difficulty);
  const specialRules = generateSpecialRules(rng, config.difficulty);
  const tokens = generateTokens(
    rng,
    tileCount,
    config.difficulty,
    config.playerCount,
    objectives,
  );
  const conditions = generateConditions(objectives, config.difficulty, rng);
  const difficultyModifiers = generateDifficultyModifiers(config.difficulty);
  const mapLayout = generateMapLayout(tiles, tokens, objectives, config.difficulty, rng);

  return {
    name,
    icon,
    narrative,
    seed: config.seed,
    config,
    tiles,
    mapLayout,
    objectives,
    specialRules,
    tokens,
    conditions,
    difficultyModifiers,
  };
}

/** –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Å–∏–¥–∞ */
export function randomSeed(): string {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
  let result = '';
  for (let i = 0; i < 8; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return result;
}
